<%# app/views/admin/pending_actions/_pending_action.html.erb %>
<tr id="<%= dom_id(action) %>" class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
  <td class="py-4 px-2">
    <div class="font-medium text-gray-900"><%= action.user.username %></div>
    <div class="text-xs text-gray-500">Karma: <%= action.user.karma %></div>
  </td>

  <td class="py-4 px-2">
    <% if action.action_type == 'claim_win' %>
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-amber-100 text-amber-800 border border-amber-200">
        üèÜ <%= action.action_type.humanize %>
      </span>
    <% else %>
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
        <%= action.action_type.humanize %>
      </span>
    <% end %>
  </td>

  <td class="py-4 px-2 text-sm text-gray-600">
    <% if action.action_type == 'mark_cell' %>
      <span class="font-semibold text-gray-800"><%= action.target.coordinate %></span>: 
      <span class="italic text-gray-500">"<%= action.target.bingo_item.content %>"</span>
<% 
   # USE THE HELPER HERE
   target_coord = action.request_coordinate
   
   # Calculate similar count safely
   similar_count = 0
   if target_coord.present?
     similar_count = PendingAction.pending
                                  .where(action_type: 'mark_cell')
                                  .select { |pa| pa.request_coordinate == target_coord }
                                  .count
   end
%>

<% if similar_count > 1 %>
  <div class="mt-2">
    <%= button_to approve_similar_admin_pending_action_path(action), 
        method: :patch,
        class: "group flex items-center gap-1.5 text-[10px] font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 px-2 py-1 rounded transition-all",
        form: { style: "display:inline-block;" } do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
      </svg>
      Approve all <%= similar_count %> matching "<%= target_coord %>"
    <% end %>
  </div>
<% end %>


      
    <% elsif action.action_type == 'claim_win' %>
      <div class="flex flex-col gap-1">
        <span class="text-red-600 font-bold uppercase text-[10px] tracking-wider">Verification Required</span>
        <%= link_to admin_bingo_card_path(action.target), target: "_blank", class: "text-blue-600 hover:text-blue-800 flex items-center gap-1 underline underline-offset-2" do %>
          <span>View Full Card</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
        <% end %>
      </div>
    <% end %>
  </td>

  <td class="py-4 px-2">
    <div class="flex items-center gap-2">
      <%= button_to admin_pending_action_path(action, decision: 'approve'), 
                    method: :patch, 
                    class: "bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1.5 px-3 rounded shadow-sm transition-all active:scale-95" do %>
        Approve
      <% end %>

      <%= button_to admin_pending_action_path(action, decision: 'deny'), 
                    method: :patch, 
                    class: "bg-white hover:bg-red-50 text-red-600 border border-red-200 text-xs font-bold py-1.5 px-3 rounded transition-all active:scale-95" do %>
        Deny
      <% end %>
    </div>
  </td>
</tr>