<div class="min-h-screen bg-slate-950 text-slate-200 font-sans">
  <nav class="border-b border-slate-800 bg-slate-900 px-4 py-3 flex items-center justify-between sticky top-0 z-50">
    <div class="flex items-center gap-4">
      <span class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-600 bg-clip-text text-transparent">
        SHIRE-TRADE
      </span>
      <div class="hidden md:flex items-center bg-slate-800 rounded-full px-3 py-1 border border-slate-700">
        <span class="text-xs text-slate-400 mr-2 uppercase tracking-tighter">Wallet:</span>
        <span class="text-sm font-mono text-green-400">ƒ <%= number_with_delimiter(current_user.wallet) %></span>
      </div>
    </div>

    <div class="flex items-center gap-6 text-sm font-medium">
      <%= link_to "Home", root_path, class: "hover:text-purple-400 transition" %>
      <%= link_to "Trading", "/", class: "hover:text-purple-400 transition" %>
      <%= link_to "Bingo", "/bingo-card", class: "hover:text-purple-400 transition" %>
      <%= link_to "Giveaways", "/giveaways", class: "hover:text-purple-400 transition" %>
      <div class="w-8 h-8 rounded-full border border-purple-500 overflow-hidden">
        <img src="<%= current_user.avatar %>" alt="Avatar">
      </div>
    </div>
  </nav>

  <div class="flex flex-col lg:flex-row h-[calc(100vh-64px)] overflow-hidden">
    
    <aside class="w-full lg:w-80 border-r border-slate-800 bg-slate-900/50 flex flex-col">
      <div class="p-4 border-b border-slate-800">
        <h2 class="text-xs font-semibold text-slate-500 uppercase tracking-widest">Market Overview</h2>
      </div>
      <div class="flex-1 overflow-y-auto">
        <% @tickers.each do |ticker| %>
          <% # Calculate locally within the loop to avoid scope errors %>
          <% current_price = ticker.current_price.to_f %>
          <% previous_price = ticker.previous_price.to_f %>
          <% diff = current_price - previous_price %>
          
          <%= link_to root_path(symbol: ticker.symbol), data: { turbo_frame: "active_market" }, class: "block p-4 border-b border-slate-800/50 hover:bg-slate-800/40 transition group" do %>
            <div class="flex justify-between items-start mb-1">
              <span class="font-bold text-slate-100 group-hover:text-purple-400"><%= ticker.symbol %></span>
              <span class="text-xs <%= diff >= 0 ? 'text-green-400' : 'text-red-400' %>">
                <%= diff >= 0 ? '▲' : '▼' %> 
                <%= number_to_percentage((diff / (previous_price > 0 ? previous_price : 1) * 100), precision: 2) %>
              </span>
            </div>
            <div class="text-lg font-mono">ƒ<%= number_with_precision(current_price, precision: 2) %></div>
          <% end %>
        <% end %>
      </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
      
      <div class="p-4 bg-slate-900/80 border-b border-slate-800 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="flex flex-col">
          <span class="text-[10px] text-slate-500 uppercase font-bold text-slate-400">Total Invested</span>
          <span class="text-sm font-mono font-bold">ƒ <%= number_with_delimiter(@total_invested.round(2)) %></span>
        </div>
        <div class="flex flex-col border-l border-slate-800 pl-4">
          <span class="text-[10px] text-slate-500 uppercase font-bold text-slate-400">Current Value</span>
          <span class="text-sm font-mono font-bold <%= @current_value >= @total_invested ? 'text-green-400' : 'text-red-400' %>">
            ƒ <%= number_with_delimiter(@current_value.round(2)) %>
          </span>
        </div>
        <div class="flex flex-col border-l border-slate-800 pl-4">
          <span class="text-[10px] text-slate-500 uppercase font-bold text-slate-400">ROI</span>
          <span class="text-sm font-mono font-bold <%= @current_value >= @total_invested ? 'text-green-400' : 'text-red-400' %>">
            <%= number_to_percentage(((@current_value - @total_invested) / (@total_invested.to_f > 0 ? @total_invested : 1) * 100), precision: 2) %>
          </span>
        </div>
        <div class="flex flex-col border-l border-slate-800 pl-4">
          <span class="text-[10px] text-slate-500 uppercase font-bold text-slate-400">Portfolio Health</span>
          <div class="w-full bg-slate-800 h-1.5 mt-2 rounded-full overflow-hidden">
            <div class="bg-purple-500 h-full shadow-[0_0_8px_#a855f7]" style="width: 75%"></div>
          </div>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 lg:p-6">
        <%= turbo_frame_tag "active_market" do %>
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            
            <div class="xl:col-span-2 space-y-6">
              <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                  <h1 class="text-xl font-bold flex items-center gap-2 uppercase">
                    <%= @active_ticker.name %> 
                    <span class="text-[10px] font-normal text-slate-500 bg-slate-800 px-2 py-0.5 rounded border border-slate-700 uppercase tracking-widest">Live Data</span>
                  </h1>
                  <span class="text-xs font-mono text-slate-500">LIQUIDITY: ƒ<%= number_with_delimiter(@active_ticker.liquidity.round) %></span>
                </div>
                <div class="h-[400px] w-full">
                  <canvas data-controller="candlestick" data-candlestick-data-value="<%= @active_ticker.candlestick_data.to_json %>"></canvas>
                </div>
              </div>
              
              <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-4">Volume Activity</h3>
                <%= column_chart @active_ticker.volume_data, height: "120px", library: { backgroundColor: "transparent", scales: { x: { display: false }, y: { grid: { color: "#1e293b" }, ticks: { display: false } } } } %>
              </div>
            </div>

            <div class="space-y-6">
              <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-4">Market Sentiment</h3>
                <div class="flex justify-between mb-2 text-xs font-mono">
                  <span class="text-green-400 font-bold">BUY <%= @active_ticker.buy_pressure %>%</span>
                  <span class="text-red-400 font-bold">SELL <%= @active_ticker.sell_pressure %>%</span>
                </div>
                <div class="flex h-2.5 w-full rounded-full overflow-hidden bg-slate-800 border border-slate-700">
                  <div class="bg-green-500 shadow-[0_0_10px_#22c55e]" style="width: <%= @active_ticker.buy_pressure %>%"></div>
                  <div class="bg-red-500 shadow-[0_0_10px_#ef4444]" style="width: <%= @active_ticker.sell_pressure %>%"></div>
                </div>
              </div>

              <div class="bg-slate-900 border border-slate-800 rounded-xl flex flex-col h-[450px]">
                <div class="p-3 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                  <h3 class="text-[10px] font-bold text-slate-500 uppercase">Global Order Book</h3>
                  <div class="flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-purple-500 rounded-full animate-pulse"></span>
                    <span class="text-[10px] text-purple-400 font-bold">LIVE FEED</span>
                  </div>
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-1 font-mono text-[11px]" id="ledger_entries">
                  <%= turbo_stream_from "global_ledger" %>
                  <% # Note: Ensure partial is in app/views/shared/_entry.html.erb %>
                  <%= render partial: "shared/entry", collection: @recent_ledger, as: :entry %>
                </div>
              </div>
            </div>

          </div>
        <% end %>
      </div>
    </main>
  </div>
</div>